# HereNow — Protocol (C1 WebRTC + R2 Rooms)

This document defines the on-the-wire event protocol for HereNow.

Goals:
- Ephemeral, session-scoped identity
- No persistence, no global state
- Minimal abuse surface
- Clear presence and rename semantics
- Works for WebRTC DataChannels (C1) with client-generated rooms (R2)

Non-goals:
- Authentication
- Message history
- Profiles / accounts
- Discovery / global rooms
- Reputation / moderation frameworks

---

## Core Concepts

Session
- A session is a single chat tab instance.
- A session ends immediately when the tab closes.
- Each session has a stable `session_id` for the lifetime of the tab only.

Room
- A room is identified by `room_id` generated by the client (R2).
- A room exists only while at least one participant is connected.
- There is no room listing or discovery.

Display Name
- `display_name` is mutable, session-scoped metadata.
- Display names are never persisted.
- Changing a display name triggers a system announcement.

Identity Model
- Messages are authored by `session_id`, not by `display_name`.
- UI renders the current name for a session by looking up `session_id → display_name`.
- When a rename occurs, past messages re-render under the new display name.

---

## Transport

Primary: WebRTC DataChannel messages as UTF-8 JSON.

Encoding:
- One JSON object per message.
- No binary payloads (text-only).

Ordering:
- Not guaranteed. Clients should tolerate out-of-order delivery.
- For UI coherence, clients may sort by `server_ts` if present, otherwise `client_ts` (best-effort).

---

## Message Envelope

Every message MUST be a JSON object with:

- `v` (number): protocol version (start at 1)
- `type` (string): event type (see below)
- `room_id` (string): room identifier
- `session_id` (string): stable per-tab ID (e.g., UUIDv4)
- `client_ts` (number): unix epoch milliseconds generated by sender
- `payload` (object): type-specific data

Example:
{
  "v": 1,
  "type": "msg",
  "room_id": "abc123xyz",
  "session_id": "0f2c...9a",
  "client_ts": 1769900000000,
  "payload": { ... }
}

Validation rules:
- Unknown fields are ignored.
- Missing required fields: drop message.
- Invalid types: drop message.
- All strings must be trimmed; max lengths enforced (see Limits).

---

## Event Types

### 1) join
Purpose: announce presence to peers when the user has explicitly opted in.

Direction: participant → peers

Payload:
- `display_name` (string): initial name for this session

Example payload:
{ "display_name": "Guest K7F" }

Client behavior:
- Upon receiving `join`, add/update participant entry for `session_id`.
- Emit a local system message in UI: "`display_name` joined" (optional).
- Clients MAY respond with `presence` to help late joiners (see below).

Note:
- Join MUST NOT occur unless user clicked “Enable chat for this session?”.

---

### 2) leave
Purpose: announce departure (best effort).

Direction: participant → peers

Payload: empty object {}

Client behavior:
- Upon receiving `leave`, remove participant from presence list.
- Emit a local system message: "X left" (optional).

Note:
- `leave` may not be delivered (tab close/crash). Clients must also expire peers on disconnect.

---

### 3) presence
Purpose: share a snapshot of currently known participants (helps late joiners).

Direction: participant → peers

Payload:
- `users` (array): each item:
  - `session_id` (string)
  - `display_name` (string)

Example payload:
{
  "users": [
    { "session_id": "aaa", "display_name": "Guest K7F" },
    { "session_id": "bbb", "display_name": "HereNowFan" }
  ]
}

Client behavior:
- Merge snapshot into local presence table (do not delete unknown users solely from a snapshot).
- Prefer “most recent rename” if conflicting names exist.

Security note:
- Presence snapshots are advisory; do not treat as authoritative identity.

---

### 4) msg
Purpose: user chat message.

Direction: participant → peers

Payload:
- `text` (string)

Example payload:
{ "text": "hello" }

Client behavior:
- Validate and sanitize text for display.
- Render message attributed to `session_id` with current display name mapping.

---

### 5) rename
Purpose: change display name for the current session.

Direction: participant → peers

Payload:
- `new_display_name` (string)

Example payload:
{ "new_display_name": "HereNowFan" }

Client behavior:
- Update `session_id → display_name` mapping for sender.
- Emit a system announcement in UI:
  - “OldName → NewName”
  - or “OldName changed name to NewName”
- Past messages MUST re-render under the new display name (because they belong to the same `session_id`).
- Rename MUST NOT be treated as join/leave.

Anti-spam:
- Clients SHOULD throttle outgoing rename (e.g., once per 10 seconds).
- Clients MAY ignore rapid consecutive rename events from the same session.

---

### 6) ping / pong (optional but recommended)
Purpose: connection health, latency measurement, keepalive (best effort).

ping payload:
- `nonce` (string)
pong payload:
- `nonce` (string)

Clients may send `ping` periodically only while ACTIVE.

---

### 7) error (optional)
Purpose: communicate protocol or room-level issues.

Payload:
- `code` (string) e.g., "invalid_message", "rate_limited"
- `message` (string) short human-readable

Note:
- In pure P2P, “error” is informational only.

---

## Limits (Hard Safety Rails)

Recommended limits (enforced client-side, and server-side if any signaling layer exists):

- `display_name` max length: 24 chars
- `text` max length: 1000 chars
- message rate limit: 5 messages / 10 seconds per session
- rename throttle: 1 rename / 10 seconds per session
- room participant cap (soft): 20 (beyond this, UX degrades in mesh)

Sanitization:
- Strip control characters
- Normalize whitespace
- No HTML rendering (treat as plain text)

---

## State Machine Alignment (Must Match Lifecycle)

Idle:
- No transport connections
- No protocol events sent

Consent:
- UI prompt shown
- Still no protocol events sent

Active:
- Allowed to send: join, msg, rename, ping
- Must send join exactly once at start of Active (per tab)
- Must send leave best-effort on tab close

Closed:
- Transport terminated
- No further events
- No persisted state retained

---

## Compatibility Notes

Protocol version:
- `v` begins at 1.
- Clients must ignore unknown event types.
- Backward compatibility is maintained by adding optional fields, not breaking required ones.
