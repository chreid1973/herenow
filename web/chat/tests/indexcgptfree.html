<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>HereNow — Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg:#050814;
  --panel:#0b1220;
  --border:#1c2a44;
  --text:#d6defa;
  --muted:#7c8db5;
  --accent:#4da3ff;
  --danger:#ff5c5c;
}

* { box-sizing:border-box; }

html, body {
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui, -apple-system, Segoe UI, sans-serif;
}

.app {
  display:flex;
  flex-direction:column;
  height:100vh;
}

header {
  padding:16px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, #0b1220, #050814);
}

header h1 {
  margin:0;
  font-size:18px;
}

header p {
  margin:6px 0 0;
  font-size:13px;
  color:var(--muted);
}

.setup {
  padding:16px;
  border-bottom:1px solid var(--border);
}

input[type="text"] {
  width:100%;
  padding:10px;
  background:#02040a;
  border:1px solid var(--border);
  border-radius:6px;
  color:var(--text);
}

.status {
  margin-top:8px;
  font-size:13px;
  color:var(--muted);
}

.muted-bar {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  padding:8px 12px;
  background:#071021;
  border-bottom:1px solid var(--border);
}

.muted-chip {
  background:#0b1220;
  border:1px solid var(--border);
  border-radius:999px;
  padding:4px 10px;
  font-size:12px;
  display:flex;
  gap:6px;
  align-items:center;
}

.muted-chip button {
  background:none;
  border:none;
  color:var(--accent);
  cursor:pointer;
  font-size:12px;
}

.chat {
  flex:1;
  overflow-y:auto;
  padding:16px;
}

.msg {
  max-width:70%;
  margin-bottom:12px;
  padding:10px;
  border-radius:10px;
  background:#0b1220;
  border-left:4px solid var(--accent);
}

.msg.me {
  margin-left:auto;
  border-left-color:#3ddc97;
}

.msg .meta {
  font-size:12px;
  color:var(--muted);
  margin-bottom:4px;
}

.msg .actions {
  margin-top:6px;
  font-size:12px;
}

.msg .actions button {
  background:none;
  border:none;
  color:var(--accent);
  cursor:pointer;
  margin-right:8px;
}

.composer {
  border-top:1px solid var(--border);
  padding:12px;
  display:flex;
  gap:8px;
}

.composer input {
  flex:1;
}

button.primary {
  background:var(--accent);
  border:none;
  color:#000;
  padding:10px 14px;
  border-radius:6px;
  cursor:pointer;
}

button.danger {
  background:var(--danger);
  border:none;
  color:#000;
  padding:10px 14px;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="app">

<header>
  <h1>HereNow — Chat</h1>
  <p>This page stays idle until you explicitly opt in. Close tab = chat off.</p>
</header>

<section class="setup">
  <label>Chat handle (session-only)</label>
  <input id="handleInput" type="text" placeholder="e.g. frodo" />
  <div id="status" class="status">Session idle.</div>
</section>

<div id="mutedBar" class="muted-bar" style="display:none;"></div>

<div id="chat" class="chat"></div>

<div class="composer">
  <input id="msgInput" type="text" placeholder="Type a message…" disabled />
  <button id="sendBtn" class="primary" disabled>Send</button>
</div>

</div>

<script>
/* ---------------- CORE STATE ---------------- */

const isHost = !location.search.includes("peer=");
const muted = new Map(); // peerId -> timeoutId
const mutedBar = document.getElementById("mutedBar");

let myHandle = "";
let peers = {};

/* ⚠️ KEEP YOUR SIGNALING URL IF DIFFERENT */
const SIGNAL_URL = "wss://herenow-signal.the-geek.workers.dev/signal";

/* ---------------- UI HELPERS ---------------- */

function updateMutedBar() {
  mutedBar.innerHTML = "";
  if (muted.size === 0) {
    mutedBar.style.display = "none";
    return;
  }
  mutedBar.style.display = "flex";
  muted.forEach((_, peerId) => {
    const chip = document.createElement("div");
    chip.className = "muted-chip";
    chip.innerHTML = `Muted: ${peerId} <button>Unmute</button>`;
    chip.querySelector("button").onclick = () => unmute(peerId);
    mutedBar.appendChild(chip);
  });
}

function mute(peerId, minutes) {
  unmute(peerId);
  const timeout = setTimeout(() => unmute(peerId), minutes * 60000);
  muted.set(peerId, timeout);
  updateMutedBar();
}

function unmute(peerId) {
  if (muted.has(peerId)) {
    clearTimeout(muted.get(peerId));
    muted.delete(peerId);
    updateMutedBar();
  }
}

/* ---------------- CHAT ---------------- */

function addMessage({ from, text, me }) {
  if (muted.has(from)) return;

  const div = document.createElement("div");
  div.className = "msg" + (me ? " me" : "");
  div.innerHTML = `
    <div class="meta">${from}</div>
    <div>${text}</div>
    <div class="actions"></div>
  `;

  if (!me) {
    const actions = div.querySelector(".actions");

    const muteBtn = document.createElement("button");
    muteBtn.textContent = "Mute";
    muteBtn.onclick = () => {
      const mins = prompt("Mute for how many minutes? (15 / 30 / 60)", "15");
      if ([15,30,60].includes(+mins)) mute(from, +mins);
    };
    actions.appendChild(muteBtn);

    if (isHost) {
      const kickBtn = document.createElement("button");
      kickBtn.textContent = "Kick";
      kickBtn.onclick = () => alert("Kick sent (host-only)");
      actions.appendChild(kickBtn);
    }
  }

  document.getElementById("chat").appendChild(div);
  div.scrollIntoView({ behavior:"smooth", block:"end" });
}

/* ---------------- BOOT ---------------- */

document.getElementById("handleInput").addEventListener("change", e => {
  myHandle = e.target.value.trim();
  if (!myHandle) return;
  document.getElementById("status").textContent = "Session live.";
  document.getElementById("msgInput").disabled = false;
  document.getElementById("sendBtn").disabled = false;
});

document.getElementById("sendBtn").onclick = () => {
  const input = document.getElementById("msgInput");
  if (!input.value) return;
  addMessage({ from: myHandle, text: input.value, me:true });
  input.value = "";
};
</script>
</body>
</html>
